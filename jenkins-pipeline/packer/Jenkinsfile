pipeline {
    agent any

    stages {
        stage('Setup') {
            steps {
                echo 'Setup Environment'
                sh 'rsync -vaP /home/jenkins/.ssh/"${JENKINS_SSH_KEY}" packer/builds/"${IMAGE_TYPE}"'
                sh 'echo ${BUILD_REGION}'
                sh 'echo ${BUILD_ENVIRONMENT}'
                sh 'echo ${APPLICATION_RELEASE_NAME}'
                sh 'echo ${APPLICATION_DISPLAY_NAME}'
            }
        }
        stage('Build Image') {
            steps {
               echo 'Build Packer Image'
               sh '''cd packer/builds/"${IMAGE_TYPE}" && packer.io build -var build_environment="${BUILD_ENVIRONMENT}" -var build_region="${BUILD_REGION}" -var packer_vpc_id="${PACKER_VPC_ID}" -var packer_subnet_id="${PACKER_SUBNET_ID}" -var packer_sg_cidr="${PACKER_SG_CIDR}" -var packer_ssh_interface="${PACKER_SSH_INTERFACE}" -var packer_ssh_keypair="${PACKER_SSH_KEYPAIR}" -var packer_ssh_keypair_file="${PACKER_SSH_KEYPAIR_FILE}" -var packer_iam_profile="${PACKER_IAM_PROFILE}" -var application_version="${APPLICATION_VERSION_NUMBER}" -var application_release_type="${APPLICATION_RELEASE_TYPE}" -var application_release_type_sequence="${APPLICATION_RELEASE_SEQUENCE}" -var application_release_name="${APPLICATION_RELEASE_NAME}" -var application_release_upload_key="${APPLICATION_RELEASE_UPLOAD_KEY}" -var cicd_pipeline_s3_bucket="${CICD_PIPELINE_S3_BUCKET_NAME}" -var monitor_endpoint="${MONITOR_ENDPOINT}" -var cylance_token_ssm_key="${CYLANCE_TOKEN_SSM_KEY}" -var cylance_zone_ssm_key="${CYLANCE_ZONE_SSM_KEY}" -var windows_cw_agent_config="${WIN_CW_AGENT_CONFIG_SSM_KEY}" ${IMAGE_TYPE}.packer'''
            }
            post {
            failure {
            mail to: 'dpreble@brierley.com',
                 subject: "Failed Pipeline: ${currentBuild.fullDisplayName}",
                 body: "Something is wrong with ${env.BUILD_URL}"

             }
          }
        }
        stage('Create Environment') {
        steps {
           echo 'Creating Environment From Image'
          }
        }
      }
      post {
            success {
            mail to: 'dpreble@brierley.com',
                 subject: "Successful Pipeline: ${currentBuild.fullDisplayName}",
                 body: "Build Completed Successfully: ${env.BUILD_URL}"
      }

    }
}

